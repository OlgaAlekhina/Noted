# nameOverride: "{{ .Values.GIT_REPO }}"
nameOverride: "noted-django-app"

livenessProbe:
  tcpSocket:
    port: http
readinessProbe:
  tcpSocket:
    port: http

ports:
  - name: http
    containerPort: 8080
    protocol: TCP

service:
  type: ClusterIP
  ports:
    - port: 8080
      targetPort: 8080
      name: http

resources:
  requests:
    cpu: 100m
    memory: 100Mi

  limits:
    cpu: 200m
    memory: 500Mi

# securityContext:
#   runAsUser: 1000
#   runAsGroup: 1000
#   capabilities:
#     drop:
#       - ALL
#   readOnlyRootFilesystem: true
#   runAsNonRoot: true

volumeMounts:
  - name: static-content
    mountPath: /app/staticfiles

volumes:
  - name: nginx-config
    configMap:
      name: "noted-django-app-nginx-config"
      items:
        - key: default.conf
          path: default.conf
  - name: static-content
    emptyDir: {}

sidecars:
  - name: nginx-static-sidecar
    image: nginx:1.23.4
    ports:
      - name: static
        containerPort: 8081
        protocol: TCP
    volumeMounts:
      - name: static-content
        mountPath: /app/staticfiles
      - name: nginx-config
        mountPath: /etc/nginx/conf.d/default.conf
        subPath: default.conf

initContainers:
  - name: static-content-copy
    volumeMounts:
      - name: static-content
        mountPath: /static
    command: ['bash']
    args:
      - -c
      - |
        set -ex;
        cp -r /app/staticfiles/* /static;
        ls -la /static;

ingress:
  enabled: true
  tlsEnabled: true
  servicePort: 8080
  tlsSecretName: noted-django-app-tls
  ingressClassName: nginx
